<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Banana Pro è®¾è®¡å¸ˆ Agent</title>
    <style>
        :root { --primary: #7c3aed; --bg: #f3f4f6; }
        body { font-family: system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; }


        .header { display: none; }
        .container { display: flex; gap: 15px; flex: 1; min-height: 0; }

        /* èŠå¤©å†å²åŒºï¼ˆå·¦ä¾§ï¼‰ */
        .chat-panel { width: 340px; flex-shrink: 0; background: white; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; }
        .chat-history { flex: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; min-height: 0; }

        .message { margin-bottom: 15px; display: flex; flex-direction: column; }
        .message.user { align-items: flex-end; }
        .message.ai { align-items: flex-start; }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .bubble {
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 100%;
            font-size: 14px;
            position: relative;
            word-wrap: break-word;
            word-break: break-word;
            flex: 1;
        }
        .user .bubble { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .ai .bubble { background: #f3f4f6; color: #333; border-bottom-left-radius: 2px; border: 1px solid #e5e7eb; }

        .copy-btn {
            background: rgba(255,255,255,0.8);
            color: #666;
            border: 1px solid #ddd;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .copy-btn:hover {
            background: white;
            color: var(--primary);
            border-color: var(--primary);
        }

        .mini-img { max-width: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* å½“å‰ç”»æ¿åŒºï¼ˆå³ä¾§ï¼‰- æ— é™ç”»å¸ƒ */
        .canvas-panel { flex: 1; background: #1e1e1e; border-radius: 16px; position: relative; overflow: hidden; cursor: grab; }
        .canvas-panel:active { cursor: grabbing; }

        /* ç½‘æ ¼èƒŒæ™¯ */
        .canvas-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* ç”»å¸ƒå®¹å™¨ */
        .canvas-viewport {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
        }

        /* ç”»å¸ƒä¸­çš„å›¾ç‰‡å®¹å™¨ */
        .canvas-images {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 40px;
            justify-content: center;
            align-content: flex-start;
        }

        /* ç”»å¸ƒä¸­çš„å•ä¸ªå›¾ç‰‡ */
        .canvas-image {
            position: relative;
            max-width: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 3px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            user-select: none;
        }
        .canvas-image:active { cursor: grabbing; }
        .canvas-image:hover { border-color: rgba(124, 58, 237, 0.6); transform: scale(1.02); }
        .canvas-image.active { border-color: var(--primary); z-index: 100; box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.3); }
        .canvas-image.selected { border-color: #22c55e; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3); }
        .canvas-image.grouped { border-color: #f59e0b; border-style: dashed; }

        /* æ¡†é€‰çŸ©å½¢ */
        .selection-rect {
            position: absolute;
            border: 2px dashed #7c3aed;
            background: rgba(124, 58, 237, 0.1);
            pointer-events: none;
            z-index: 50;
            display: none;
        }
        .selection-rect.show { display: block; }

        /* ç”Ÿæˆä¸­çŠ¶æ€ */
        .canvas-image.generating {
            opacity: 0.5;
            border-color: #eab308;
            animation: pulse 1s infinite;
        }

        /* å›¾ç‰‡ç¼–å·æ ‡ç­¾ */
        .image-number {
            position: absolute;
            top: -12px;
            left: -12px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .canvas-image.selected .image-number {
            background: #22c55e;
        }

        /* ä¸‹è½½æŒ‰é’® */
        .download-btn {
            background: #22c55e;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.2s;
            margin-right: 4px;
        }
        .download-btn:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }

        /* åˆ é™¤æŒ‰é’® */
        .delete-btn {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        .delete-btn:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        /* å›¾ç‰‡åº•éƒ¨å·¥å…·æ  */
        .image-tools {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s, bottom 0.2s;
            z-index: 20;
        }
        .canvas-image:hover .image-tools {
            opacity: 1;
            bottom: -40px;
        }

        /* å›¾ç‰‡å°ºå¯¸æ˜¾ç¤º */
        .image-size {
            position: absolute;
            top: -12px;
            right: -12px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            z-index: 5;
            pointer-events: none;
            white-space: nowrap;
        }

        /* è°ƒæ•´å¤§å°çš„æ‰‹æŸ„ */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            background: var(--primary);
            border-radius: 4px 0 0 0;
            cursor: se-resize;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .canvas-image:hover .resize-handle {
            opacity: 0.7;
        }
        .resize-handle:hover {
            opacity: 1 !important;
        }

        /* èŠå¤©ä¸­çš„å›¾ç‰‡å¼•ç”¨æ ‡ç­¾ */
        .image-ref {
            display: inline-flex;
            align-items: center;
            background: #e0e7ff;
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
            cursor: pointer;
            border: 1px solid rgba(124, 58, 237, 0.3);
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .image-ref:hover {
            background: var(--primary);
            color: white;
        }
        .image-ref .remove {
            margin-left: 6px;
            cursor: pointer;
            opacity: 0.7;
        }
        .image-ref .remove:hover {
            opacity: 1;
        }

        /* å·¥å…·æ  */
        .canvas-toolbar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 8px 16px;
            border-radius: 24px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .toolbar-btn:hover { background: rgba(255,255,255,0.2); }
        .toolbar-info { color: rgba(255,255,255,0.7); font-size: 12px; min-width: 60px; text-align: center; }

        /* é€‰ä¸­çš„å›¾ç‰‡æç¤º */
        .selected-hint {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }
        .selected-hint.show { display: flex; }

        .agent-status { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 6px; z-index: 100; }
        .dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; }
        .dot.thinking { background: #eab308; animation: pulse 1s infinite; }

        /* è¾“å…¥åŒº */
        .input-area { display: flex; gap: 10px; }
        .input-area input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        .input-area input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        button { padding: 12px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }

        /* è®¾ç½®å¼¹çª— */
        .config-box { margin-bottom: 10px; padding: 10px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 12px; flex-shrink: 0; }
        .config-box input { width: 45%; padding: 5px; margin-right: 5px; border: 1px solid #cbd5e1; border-radius: 4px; box-sizing: border-box; }

        /* ç”Ÿæˆè®¾ç½®åŒºåŸŸ */
        .generation-settings {
            margin-bottom: 10px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #bae6fd;
            font-size: 12px;
            flex-shrink: 0;
        }
        .generation-settings .label {
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 6px;
            display: block;
        }
        .generation-settings select {
            width: 48%;
            padding: 6px;
            margin-right: 2%;
            margin-bottom: 6px;
            border: 1px solid #94a3b8;
            border-radius: 4px;
            background: white;
            font-size: 12px;
            box-sizing: border-box;
            cursor: pointer;
        }
        .generation-settings input[type="text"] {
            width: 100%;
            padding: 6px;
            border: 1px solid #94a3b8;
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
        }
        .generation-settings .settings-row {
            display: flex;
            gap: 2%;
            margin-bottom: 6px;
        }
        .generation-settings .settings-row > * {
            width: 48%;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* å³é”®èœå• */
        .context-menu {
            position: fixed;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 150px;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
        }
        .context-menu.show { display: block; }
        .context-menu-item {
            padding: 10px 16px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            transition: background 0.2s;
        }
        .context-menu-item:hover { background: rgba(124, 58, 237, 0.3); }
        .context-menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 6px 0;
        }

    /* ç¼–è¾‘å·¥å…·æ  */
    .edit-toolbar {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        padding: 8px 12px;
        border-radius: 6px;
        display: flex;
        gap: 8px;
        align-items: center;
        z-index: 20;
        display: none;
    }
    .edit-toolbar.show { display: flex; }
    .edit-tool-btn {
        background: rgba(255,255,255,0.15);
        border: none;
        color: white;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
    }
    .edit-tool-btn:hover { background: rgba(255,255,255,0.25); }
    .edit-tool-btn.active { background: #7c3aed; }

    /* ç¼–è¾‘ç”»å¸ƒ */
    .edit-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 5;
        background: transparent;
    }
    .edit-canvas.active { pointer-events: auto; cursor: crosshair; }

        /* è£å‰ªæ¡† */
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10;
            display: none;
        }
        .crop-overlay.show { display: block; }
        .crop-box {
            position: absolute;
            border: 2px dashed #fff;
            background: transparent;
            cursor: move;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }
        .crop-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border: 1px solid #7c3aed;
            border-radius: 50%;
        }
        .crop-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .crop-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .crop-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }

        /* æ–‡å­—è¾“å…¥æ¡† */
        .text-input-box {
            position: absolute;
            background: rgba(0,0,0,0.85);
            padding: 12px;
            border-radius: 8px;
            z-index: 100;
            display: none;
            border: 1px solid rgba(124, 58, 237, 0.5);
        }
        .text-input-box.show { display: block; }
        .text-input-box input {
            background: rgba(255,255,255,0.95);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            outline: none;
            min-width: 180px;
            font-size: 14px;
        }
        .text-input-box .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .text-input-box button {
            padding: 6px 14px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .text-input-box .confirm { background: #22c55e; color: white; }
        .text-input-box .cancel { background: #ef4444; color: white; }

        /* ç‹¬ç«‹ç¼–è¾‘çª—å£ */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .edit-modal.show { display: flex; }
        .edit-modal-content {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }
        .edit-modal-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .edit-modal-close:hover { background: rgba(255,255,255,0.2); }
        .edit-modal-canvas-container {
            position: relative;
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 400px;
            min-height: 300px;
        }
        .edit-modal-canvas {
            max-width: 100%;
            max-height: 60vh;
            display: block;
        }
        /* è£å‰ªé®ç½© */
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 10;
        }
        .crop-overlay.show { display: block; }
        .crop-box {
            position: absolute;
            border: 2px dashed #fff;
            background: transparent;
            cursor: move;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
        }
        .crop-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #7c3aed;
            border: 2px solid white;
            border-radius: 50%;
        }
        .crop-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .crop-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .crop-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }
        .edit-modal-toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        .edit-modal-toolbar button {
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 4px;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }
        .edit-modal-toolbar button:hover { background: rgba(255,255,255,0.25); }
        .edit-modal-toolbar button.active { background: #7c3aed; }
        .edit-modal-toolbar input[type="color"] {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .edit-modal-toolbar input[type="range"] {
            width: 80px;
        }
        .edit-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .edit-modal-actions button {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            color: white;
            cursor: pointer;
        }
        .edit-modal-actions .confirm { background: #22c55e; }
        .edit-modal-actions .confirm:hover { background: #16a34a; }
        .edit-modal-actions .cancel { background: #ef4444; }
        .edit-modal-actions .cancel:hover { background: #dc2626; }

        /* åŠŸèƒ½åˆ‡æ¢å¡ç‰‡ */
        .mode-switcher {
            display: flex;
            background: #e2e8f0;
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 12px;
        }
        .mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* è§†é¢‘ç”Ÿæˆè®¾ç½®åŒºåŸŸ */
        .video-settings {
            margin-bottom: 10px;
            padding: 10px;
            background: #fef3c7;
            border-radius: 8px;
            border: 1px solid #fbbf24;
            font-size: 12px;
            flex-shrink: 0;
            display: none;
        }
        .video-settings.show { display: block; }
        .video-settings .label {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 6px;
            display: block;
        }
        .video-settings select, .video-settings input[type="text"] {
            width: 100%;
            padding: 6px;
            margin-bottom: 6px;
            border: 1px solid #d97706;
            border-radius: 4px;
            background: white;
            font-size: 12px;
            box-sizing: border-box;
            cursor: pointer;
        }
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .checkbox-row input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .checkbox-row label {
            color: #92400e;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.95);
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 2000;
            display: none;
            min-width: 300px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .progress-container.show { display: block; }
        .progress-title {
            color: white;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7c3aed, #22c55e);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .progress-status {
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            margin-top: 8px;
        }

        /* è§†é¢‘å®¹å™¨ */
        .video-container {
            position: relative;
            max-width: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 3px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            user-select: none;
            background: #000;
        }
        .video-container:active { cursor: grabbing; }
        .video-container:hover { border-color: rgba(124, 58, 237, 0.6); transform: scale(1.02); }
        .video-container.selected { border-color: #22c55e; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3); }
        .video-container video {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 5px;
        }

        /* å¯åŠ¨åŠ¨ç”»å±‚ */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }
        .splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .splash-logo {
            font-size: 48px;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
            animation: logoBounce 3s ease-out;
        }
        .splash-loading {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .splash-text {
            color: white;
            margin-top: 20px;
            font-size: 16px;
            opacity: 0;
            animation: fadeIn 0.5s ease-out 0.5s forwards;
        }

        @keyframes logoBounce {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* ä¸»ç•Œé¢æ·¡å…¥åŠ¨ç”» */
        .container {
            animation: containerFadeIn 0.8s ease-out;
        }
        @keyframes containerFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ç¼¤çº·ç¤¼èŠ±ç²’å­ */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            opacity: 0;
            z-index: 10000;
            pointer-events: none;
        }
    </style>
</head>
<body>

<!-- è¿›åº¦æ¡ -->
<div class="progress-container" id="progressContainer">
    <div class="progress-title">
        <span class="dot thinking"></span>
        <span id="progressTitle">æ­£åœ¨ç”Ÿæˆè§†é¢‘...</span>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-status" id="progressStatus">å‡†å¤‡ä¸­...</div>
</div>

<!-- å¯åŠ¨åŠ¨ç”»å±‚ -->
<div class="splash-screen" id="splashScreen">
    <div class="splash-logo">ğŸ¨ Banana Pro è®¾è®¡å¸ˆ Agent</div>
    <div class="splash-loading"></div>
    <div class="splash-text">ç­‘é›…è®¾è®¡â€”â€”3.0ç‰ˆæœ¬</div>
</div>

<!-- å³é”®èœå• -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" data-action="brush">âœï¸ ç¬”æ ‡æ³¨</div>
    <div class="context-menu-item" data-action="text">ğŸ“ æ–‡å­—æ ‡æ³¨</div>
    <div class="context-menu-item" data-action="crop">âœ‚ï¸ è£å‰ª</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="download">ğŸ“¥ æ‰¹é‡ä¸‹è½½</div>
    <div class="context-menu-item" data-action="group">ğŸ“¦ æˆç»„</div>
    <div class="context-menu-item" data-action="ungroup">ğŸ“¤ è§£ç»„</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" data-action="reset">ğŸ”„ é‡ç½®ç¼–è¾‘</div>
</div>

<!-- æ¡†é€‰çŸ©å½¢ -->
<div class="selection-rect" id="selectionRect"></div>

<!-- æ–‡å­—è¾“å…¥æ¡† -->
<div class="text-input-box" id="textInputBox">
    <input type="text" placeholder="è¾“å…¥æ–‡å­—å†…å®¹..." id="textInput">
    <div class="btn-group">
        <button class="confirm">ç¡®å®š</button>
        <button class="cancel">å–æ¶ˆ</button>
    </div>
</div>

<!-- ç‹¬ç«‹ç¼–è¾‘çª—å£ -->
<div class="edit-modal" id="editModal">
    <div class="edit-modal-content">
        <div class="edit-modal-header">
            <span>ğŸ–¼ï¸ å›¾ç‰‡ç¼–è¾‘</span>
            <button class="edit-modal-close" onclick="closeEditModal()">âœ•</button>
        </div>
        <div class="edit-modal-canvas-container">
            <canvas id="editModalCanvas" class="edit-modal-canvas"></canvas>
            <div class="crop-overlay" id="cropOverlay">
                <div class="crop-box" id="cropBox">
                    <div class="crop-handle nw"></div>
                    <div class="crop-handle ne"></div>
                    <div class="crop-handle sw"></div>
                    <div class="crop-handle se"></div>
                </div>
            </div>
        </div>
        <div class="edit-modal-toolbar">
            <button class="edit-tool-btn active" data-tool="brush" onclick="setEditMode('brush')">âœï¸ ç”»ç¬”</button>
            <button class="edit-tool-btn" data-tool="text" onclick="setEditMode('text')">ğŸ“ æ–‡å­—</button>
            <button class="edit-tool-btn" data-tool="eraser" onclick="setEditMode('eraser')">ğŸ§¹ æ©¡çš®</button>
            <button class="edit-tool-btn" data-tool="crop" onclick="setEditMode('crop')">âœ‚ï¸ è£å‰ª</button>
            <input type="color" id="modalColorPicker" value="#ff0000" title="é¢œè‰²">
            <input type="range" id="modalBrushSize" min="1" max="20" value="3" title="å¤§å°">
            <span style="color:#aaa;font-size:12px;">æç¤º: æ–‡å­—æ¨¡å¼ç‚¹å‡»ç”»å¸ƒæ·»åŠ æ–‡å­— | è£å‰ªåç‚¹å‡»ç¡®å®šä¿å­˜</span>
        </div>
        <div class="edit-modal-actions">
            <button class="cancel" onclick="closeEditModal()">âœ— å–æ¶ˆ</button>
            <button class="confirm" onclick="confirmModalEdit()">âœ“ ç¡®å®šä¿å­˜</button>
        </div>
    </div>
</div>

<div class="container">
    <!-- å·¦ä¾§ï¼šå¯¹è¯æ§åˆ¶å° -->
    <div class="chat-panel">
        <div class="config-box">
            <input type="text" id="baseUrl" placeholder="Base URL">
            <input type="password" id="apiKey" placeholder="API Key">
        </div>

        <!-- åŠŸèƒ½åˆ‡æ¢ -->
        <div class="mode-switcher">
            <button class="mode-btn active" data-mode="image" onclick="switchMode('image')">ğŸ–¼ï¸ å›¾ç‰‡ç”Ÿæˆ</button>
            <button class="mode-btn" data-mode="video" onclick="switchMode('video')">ğŸ¬ è§†é¢‘ç”Ÿæˆ</button>
        </div>

        <div class="generation-settings" id="imageSettings">
            <span class="label">ğŸ“ ç”Ÿæˆè®¾ç½®</span>
            <div class="settings-row">
                <select id="aspectRatio">
                    <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                    <option value="4:3">4:3 (æ ‡å‡†)</option>
                    <option value="3:4">3:4 (è‚–åƒ)</option>
                    <option value="16:9">16:9 (å®½å±)</option>
                    <option value="9:16">9:16 (ç«–å±)</option>
                    <option value="2:3">2:3 (ç«–é•¿)</option>
                    <option value="3:2">3:2 (æ¨ªé•¿)</option>
                    <option value="4:5">4:5 (ç«–æ–¹)</option>
                    <option value="5:4">5:4 (æ¨ªæ–¹)</option>
                    <option value="21:9">21:9 (è¶…å®½)</option>
                </select>
                <select id="resolution">
                    <option value="1K">1K</option>
                    <option value="2K">2K</option>
                    <option value="4K" selected>4K</option>
                </select>
            </div>
            <select id="modelSelect">
                <option value="nano-banana" selected>nano-banana (æ¨è)</option>
                <option value="nano-banana-2">nano-banana-2</option>
                <option value="nano-banana-hd">nano-banana-hd (4Ké«˜æ¸…)</option>
                <option value="custom">è‡ªå®šä¹‰æ¨¡å‹</option>
            </select>
            <select id="responseFormat">
                <option value="url" selected>URLé“¾æ¥</option>
                <option value="b64_json">Base64ç¼–ç </option>
            </select>
            <input type="text" id="customModel" placeholder="è‡ªå®šä¹‰æ¨¡å‹åç§°ï¼ˆå¦‚éœ€ï¼‰" style="display:none;">
        </div>

        <!-- è§†é¢‘ç”Ÿæˆè®¾ç½® -->
        <div class="video-settings" id="videoSettings">
            <span class="label">ğŸ¬ è§†é¢‘ç”Ÿæˆè®¾ç½®</span>
            <select id="videoModel">
                <option value="veo3.1">veo3.1 (å¿«é€Ÿæ¨¡å¼,æ”¯æŒéŸ³é¢‘)</option>
                <option value="veo3.1-pro">veo3.1-pro (é«˜è´¨é‡æ¨¡å¼,æ”¯æŒéŸ³é¢‘)</option>
                <option value="veo3-pro-frames">veo3-pro-frames (å•å›¾å‚è€ƒ)</option>
                <option value="veo3-fast-frames">veo3-fast-frames (å¿«é€Ÿå›¾ç”Ÿè§†é¢‘)</option>
                <option value="veo2-fast-frames">veo2-fast-frames (æ”¯æŒé¦–å°¾å¸§)</option>
                <option value="veo2-fast-components">veo2-fast-components (å¤šå›¾å…ƒç´ )</option>
                <option value="veo3.1-components">veo3.1-components (1-3å¼ å›¾å‚è€ƒ)</option>
            </select>
            <select id="videoAspectRatio">
                <option value="16:9" selected>16:9 (æ¨ªå±)</option>
                <option value="9:16">9:16 (ç«–å±)</option>
            </select>
            <div class="checkbox-row">
                <input type="checkbox" id="enhancePrompt">
                <label for="enhancePrompt">ä¼˜åŒ–æç¤ºè¯ï¼ˆä¸­æ–‡è½¬è‹±æ–‡ï¼‰</label>
            </div>
        </div>

        <div class="chat-history" id="chatBox">
            <div class="message ai">
                <div class="bubble">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„è®¾è®¡åŠ©ç†ã€‚ç‚¹å‡»å³ä¾§ç”»å¸ƒä¸­çš„å›¾ç‰‡å¯æ·»åŠ åˆ°å‚è€ƒåˆ—è¡¨ï¼ˆæ”¯æŒå¤šé€‰ï¼‰ï¼Œç„¶åè¾“å…¥æŒ‡ä»¤å‘é€ã€‚æ”¯æŒæ»šè½®ç¼©æ”¾ç”»å¸ƒã€æ‹–æ‹½å¹³ç§»ã€æ‹–æ‹½å›¾ç‰‡ã€åŒå‡»åˆ é™¤å›¾ç‰‡ã€‚</div>
            </div>
        </div>

        <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ï¼ˆæ”¯æŒå¤šé€‰ï¼‰ -->
        <input type="file" id="fi" style="display:none" multiple accept="image/*" onchange="handleUpload(this)">

        <div class="input-area">
            <button onclick="document.getElementById('fi').click()" style="background:#64748b">ğŸ“‚ ä¼ å›¾</button>
            <input type="text" id="prompt" placeholder="ç‚¹å‡»å³ä¾§å›¾ç‰‡æ·»åŠ åˆ°å‚è€ƒåˆ—è¡¨..." onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()" id="sendBtn">å‘é€</button>
        </div>
        <div id="imageRefs" style="display: flex; flex-wrap: wrap; gap: 4px; padding: 8px 0; border-top: 1px solid #eee;"></div>
    </div>

    <!-- å³ä¾§ï¼šæ— é™ç”»å¸ƒ -->
    <div class="canvas-panel" id="canvasPanel">
        <div class="canvas-grid"></div>
        <div class="canvas-viewport" id="canvasViewport">
            <div class="canvas-images" id="canvasImages">
                <div id="placeholder" style="color:#666; white-space:nowrap; display:flex; flex-direction:column; align-items:center; gap:8px;">
                    <div>æ‹–æ‹½å›¾ç‰‡åˆ°ç”»å¸ƒæˆ–ä¸Šä¼ å›¾ç‰‡</div>
                    <div style="font-size:14px; color:#999;">ç­‘é›…è®¾è®¡â€”â€”3.0ç‰ˆæœ¬</div>
                </div>
            </div>
        </div>

        <div class="selected-hint" id="selectedHint" onclick="clearAllRefs()" style="cursor: pointer;">
            âœ“ å·²é€‰ä¸­ ${canvasState.referencedImageIds.size} å¼ å›¾ç‰‡ (ç‚¹å‡»æ¸…é™¤)
        </div>

        <div class="agent-status">
            <div class="dot" id="statusDot"></div>
            <span id="statusText">Agent å°±ç»ª (æ— é™ç”»å¸ƒæ¨¡å¼)</span>
        </div>

        <div class="canvas-toolbar">
            <button class="toolbar-btn" onclick="resetCanvas()">ğŸ”„ é‡ç½®</button>
            <span class="toolbar-info" id="zoomInfo">100%</span>
            <button class="toolbar-btn" onclick="zoomIn()">â• æ”¾å¤§</button>
            <button class="toolbar-btn" onclick="zoomOut()">â– ç¼©å°</button>
        </div>
    </div>
</div>

<script>
    window.addEventListener('load', () => {
        // æ¢å¤é…ç½®
        // å¯åŠ¨åŠ¨ç”» - ç«‹å³è§¦å‘ç¤¼èŠ±
        createConfetti();
        setTimeout(() => {
            const splashScreen = document.getElementById('splashScreen');
            if (splashScreen) {
                splashScreen.classList.add('hidden');
                // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                setTimeout(() => {
                    splashScreen.remove();
                }, 600);
            }
        }, 3000); // 3ç§’åéšè—å¯åŠ¨åŠ¨ç”»
        const savedBaseUrl = localStorage.getItem('baseUrl');
        const savedApiKey = localStorage.getItem('apiKey');
        const savedAspectRatio = localStorage.getItem('aspectRatio');
        const savedResolution = localStorage.getItem('resolution');
        const savedModel = localStorage.getItem('model');
        const savedResponseFormat = localStorage.getItem('responseFormat');

        if (savedBaseUrl) document.getElementById('baseUrl').value = savedBaseUrl;
        if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
        if (savedAspectRatio) document.getElementById('aspectRatio').value = savedAspectRatio;
        if (savedResolution) document.getElementById('resolution').value = savedResolution;
        if (savedModel) {
            document.getElementById('modelSelect').value = savedModel;
        }
        if (savedResponseFormat) {
            document.getElementById('responseFormat').value = savedResponseFormat;
        }

        // æ¢å¤åŠŸèƒ½æ¨¡å¼
        const savedMode = localStorage.getItem('currentMode');
        if (savedMode) {
            switchMode(savedMode);
        }
    });

    // --- AGENT çŠ¶æ€è®°å¿† ---
    let lastImageBase64 = null;
    let lastImageMime = null;

    // --- æ— é™ç”»å¸ƒçŠ¶æ€ ---
    let canvasState = {
        scale: 1,
        translateX: 0,
        translateY: 0,
        isDragging: false,
        isPanning: false,
        isSelecting: false,
        lastMouseX: 0,
        lastMouseY: 0,
        selectStartX: 0,
        selectStartY: 0,
        imageCount: 0,
        selectedImageId: null,
        referencedImageIds: new Set(),
        imageGroups: {}, // å›¾ç‰‡åˆ†ç»„ { groupId: [imgId1, imgId2, ...] }
        imageGroupMap: {}, // å›¾ç‰‡åˆ°ç»„çš„æ˜ å°„ { imgId: groupId }
        nextGroupId: 1
    };

    // --- æ ¸å¿ƒé€»è¾‘ ---
    async function send() {
        const input = document.getElementById('prompt');
        const text = input.value.trim();
        const baseUrl = document.getElementById('baseUrl').value;
        const apiKey = document.getElementById('apiKey').value;

        localStorage.setItem('baseUrl', baseUrl);
        localStorage.setItem('apiKey', apiKey);

        if (!baseUrl || !apiKey) return alert("è¯·å…ˆå¡«å†™ API é…ç½®ï¼");
        if (!text && !lastImageBase64) return alert("è¯·è¯´ç‚¹ä»€ä¹ˆï¼Œæˆ–è€…å…ˆä¸Šä¼ ä¸€å¼ å›¾");

        addMessage('user', text);
        input.value = '';
        setLoading(true);

        try {
            const parts = [];

            if (canvasState.referencedImageIds.size > 0) {
                canvasState.referencedImageIds.forEach(imgId => {
                    const imgContainer = document.getElementById(imgId);
                    if (imgContainer) {
                        const img = imgContainer.querySelector('img');
                        if (img && img.src) {
                            const base64 = img.src.split(',')[1];
                            parts.push(base64);
                        }
                    }
                });
            } else if (lastImageBase64) {
                parts.push(lastImageBase64);
            }

            const aspectRatio = document.getElementById('aspectRatio').value;
            const imageSize = document.getElementById('resolution').value;
            let modelName = document.getElementById('modelSelect').value;
            const responseFormat = document.getElementById('responseFormat').value;

            if (modelName === 'custom') {
                modelName = document.getElementById('customModel').value || 'nano-banana';
            }

            const payload = {
                model: modelName,
                prompt: text,
                aspect_ratio: aspectRatio,
                response_format: responseFormat
            };

            // æ·»åŠ å‚è€ƒå›¾
            if (parts.length > 0) {
                payload.image = parts;
            }

            // image_size å‚æ•°ä»… nano-banana-2 æ”¯æŒ
            if (modelName === 'nano-banana-2') {
                payload.image_size = imageSize;
            }

            const endpoint = `${baseUrl.replace(/\/$/, '')}/v1/images/generations`;

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || "ç”Ÿæˆå¤±è´¥");

            if (!data.data || !Array.isArray(data.data) || data.data.length === 0) {
                throw new Error("æ¨¡å‹æœªè¿”å›å›¾ç‰‡æ•°æ®");
            }

            // å¤„ç†è¿”å›çš„å›¾ç‰‡
            for (const imageData of data.data) {
                if (responseFormat === 'url' && imageData.url) {
                    // URLæ ¼å¼ï¼šä¸‹è½½å›¾ç‰‡
                    try {
                        const imgResponse = await fetch(imageData.url);
                        const blob = await imgResponse.blob();
                        const reader = new FileReader();
                        await new Promise((resolve) => {
                            reader.onload = (e) => {
                                const base64 = e.target.result.split(',')[1];
                                lastImageBase64 = base64;
                                lastImageMime = blob.type;
                                updateCanvas(lastImageBase64, lastImageMime);
                                resolve();
                            };
                            reader.readAsDataURL(blob);
                        });
                    } catch (err) {
                        console.error('ä¸‹è½½å›¾ç‰‡å¤±è´¥:', err);
                    }
                } else if (responseFormat === 'b64_json' && imageData.b64_json) {
                    // Base64æ ¼å¼ï¼šç›´æ¥ä½¿ç”¨
                    lastImageBase64 = imageData.b64_json;
                    lastImageMime = 'image/jpeg';
                    updateCanvas(lastImageBase64, lastImageMime);
                }
            }

            addMessage('ai', `å·²ç”Ÿæˆ ${data.data.length} å¼ å›¾ç‰‡ï¼Œè¯·æŸ¥çœ‹å³ä¾§ç”»å¸ƒã€‚è¿˜éœ€è¦è°ƒæ•´å—ï¼Ÿ`);

        } catch (e) {
            addMessage('ai', 'âŒ å‡ºé”™äº†: ' + e.message);
        } finally {
            setLoading(false);
        }
    }

    async function handleUpload(input) {
        const files = input.files;
        if (!files || files.length === 0) return;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();
            await new Promise(resolve => {
                reader.onload = e => {
                    const base64 = e.target.result.split(',')[1];
                    lastImageBase64 = base64;
                    lastImageMime = file.type;
                    updateCanvas(base64, file.type);
                    resolve();
                };
                reader.readAsDataURL(file);
            });
        }

        addMessage('user', `[ä¸Šä¼ äº† ${files.length} å¼ å‚è€ƒå›¾]`);
        addMessage('ai', `æ”¶åˆ° ${files.length} å¼ å‚è€ƒå›¾ï¼Œæ— è®ºæ˜¯é‡ç»˜è¿˜æ˜¯ä¿®æ”¹ï¼Œè¯·å‘Šè¯‰æˆ‘æŒ‡ä»¤ã€‚`);
    }

    function addMessage(role, text, imgData = null) {
        const box = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `message ${role}`;

        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';

        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'bubble';
        bubbleDiv.textContent = text;

        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = 'ğŸ“‹';
        copyBtn.title = 'å¤åˆ¶åˆ°è¾“å…¥æ¡†';
        copyBtn.onclick = () => {
            const input = document.getElementById('prompt');
            input.value = text;
            input.focus();
        };

        headerDiv.appendChild(bubbleDiv);
        headerDiv.appendChild(copyBtn);
        div.appendChild(headerDiv);

        if (imgData) {
            const src = `data:${imgData.mimeType};base64,${imgData.data}`;
            const miniImg = document.createElement('img');
            miniImg.src = src;
            miniImg.className = 'mini-img';
            miniImg.onclick = () => updateCanvas(imgData.data, imgData.mimeType);
            div.appendChild(miniImg);
        }

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function updateCanvas(b64, mime) {
        const imagesContainer = document.getElementById('canvasImages');
        const placeholder = document.getElementById('placeholder');

        if (placeholder) placeholder.style.display = 'none';

        const imgContainer = document.createElement('div');
        imgContainer.className = 'canvas-image';
        imgContainer.id = `canvas-image-${canvasState.imageCount}`;
        const imgNumber = canvasState.imageCount + 1;
        imgContainer.dataset.number = imgNumber;

        const numberLabel = document.createElement('div');
        numberLabel.className = 'image-number';
        numberLabel.textContent = imgNumber;
        imgContainer.appendChild(numberLabel);

        const img = document.createElement('img');
        img.src = `data:${mime};base64,${b64}`;
        img.style.display = 'block';
        img.style.borderRadius = '6px';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.onload = () => {
            const width = img.naturalWidth;
            const height = img.naturalHeight;
            const aspectRatio = width / height;

            // å­˜å‚¨å®½é«˜æ¯”åˆ°å®¹å™¨
            imgContainer.dataset.aspectRatio = aspectRatio;

            const sizeLabel = document.createElement('div');
            sizeLabel.className = 'image-size';
            sizeLabel.textContent = `${width}x${height}`;
            imgContainer.appendChild(sizeLabel);
        };
        imgContainer.appendChild(img);

        const toolsBar = document.createElement('div');
        toolsBar.className = 'image-tools';

        const downloadBtn = document.createElement('div');
        downloadBtn.className = 'download-btn';
        downloadBtn.innerHTML = 'â¬‡ ä¸‹è½½';
        downloadBtn.onclick = (e) => {
            e.stopPropagation();
            const link = document.createElement('a');
            link.href = `data:${mime};base64,${b64}`;
            link.download = `image_${imgNumber}.jpg`;
            link.click();
        };
        toolsBar.appendChild(downloadBtn);

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'ğŸ—‘ åˆ é™¤';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            removeImageRef(imgContainer.id);
            imgContainer.remove();
        };
        toolsBar.appendChild(deleteBtn);

        imgContainer.appendChild(toolsBar);

        const resizeHandle = document.createElement('div');
        resizeHandle.className = 'resize-handle';
        imgContainer.appendChild(resizeHandle);

        // åˆå§‹å°ºå¯¸è®¾ä¸º300pxå®½ï¼Œé«˜åº¦è‡ªåŠ¨æŒ‰æ¯”ä¾‹
        imgContainer.style.width = '300px';
        imgContainer.style.height = 'auto';
        imgContainer.classList.add('generating');

        makeImageResizable(imgContainer, resizeHandle);
        makeImageSelectable(imgContainer);

        imagesContainer.appendChild(imgContainer);

        canvasState.imageCount++;
        lastImageBase64 = b64;
        lastImageMime = mime;

        setTimeout(() => {
            imgContainer.classList.remove('generating');
        }, 500);
    }

    function setLoading(isLoading) {
        const btn = document.getElementById('sendBtn');
        const dot = document.getElementById('statusDot');
        const txt = document.getElementById('statusText');

        btn.disabled = isLoading;
        if (isLoading) {
            dot.className = "dot thinking";
            txt.innerText = "Agent æ€è€ƒåˆ›ä½œä¸­...";
            btn.innerText = "ç»˜åˆ¶ä¸­...";
        } else {
            dot.className = "dot";
            txt.innerText = "Agent å°±ç»ª (æ— é™ç”»å¸ƒæ¨¡å¼)";
            btn.innerText = "å‘é€";
        }
    }

    // --- æ— é™ç”»å¸ƒåŠŸèƒ½ ---

    const canvasPanel = document.getElementById('canvasPanel');

    canvasPanel.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        canvasPanel.style.boxShadow = 'inset 0 0 20px rgba(124, 58, 237, 0.5)';
    });

    canvasPanel.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        canvasPanel.style.boxShadow = 'none';
    });

    canvasPanel.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        canvasPanel.style.boxShadow = 'none';

        const files = e.dataTransfer.files;
        if (!files || files.length === 0) return;

        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
        if (imageFiles.length === 0) return;

        for (const file of imageFiles) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result.split(',')[1];
                lastImageBase64 = base64;
                lastImageMime = file.type;
                updateCanvas(base64, file.type);
            };
            reader.readAsDataURL(file);
        }

        addMessage('user', `[æ‹–æ‹½ä¸Šä¼ äº† ${imageFiles.length} å¼ å‚è€ƒå›¾]`);
        addMessage('ai', `æ”¶åˆ° ${imageFiles.length} å¼ å‚è€ƒå›¾ï¼Œæ— è®ºæ˜¯é‡ç»˜è¿˜æ˜¯ä¿®æ”¹ï¼Œè¯·å‘Šè¯‰æˆ‘æŒ‡ä»¤ã€‚`);
    });

    document.addEventListener('paste', (e) => {
        const items = e.clipboardData?.items;
        if (!items) return;

        const imageFiles = [];
        for (const item of items) {
            if (item.type.startsWith('image/')) {
                const file = item.getAsFile();
                if (file) {
                    imageFiles.push(file);
                }
            }
        }

        if (imageFiles.length === 0) return;

        for (const file of imageFiles) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result.split(',')[1];
                lastImageBase64 = base64;
                lastImageMime = file.type;
                updateCanvas(base64, file.type);
            };
            reader.readAsDataURL(file);
        }

        addMessage('user', `[ç²˜è´´äº† ${imageFiles.length} å¼ å›¾ç‰‡]`);
        addMessage('ai', `æ”¶åˆ° ${imageFiles.length} å¼ å›¾ç‰‡ï¼Œæ— è®ºæ˜¯é‡ç»˜è¿˜æ˜¯ä¿®æ”¹ï¼Œè¯·å‘Šè¯‰æˆ‘æŒ‡ä»¤ã€‚`);
    });

    function updateImageRefs() {
        const refsContainer = document.getElementById('imageRefs');
        refsContainer.innerHTML = '';

        canvasState.referencedImageIds.forEach(imgId => {
            const img = document.getElementById(imgId);
            if (!img) return;

            const refTag = document.createElement('div');
            refTag.className = 'image-ref';
            refTag.innerHTML = `
                <span>#${img.dataset.number}</span>
                <span class="remove" onclick="removeImageRef('${imgId}')">Ã—</span>
            `;
            refTag.onclick = (e) => {
                if (e.target.classList.contains('remove')) return;
                img.scrollIntoView({ behavior: 'smooth', block: 'center' });
                img.classList.add('selected');
                setTimeout(() => img.classList.remove('selected'), 1000);
            };
            refsContainer.appendChild(refTag);
        });
    }

    function addImageRef(imgId) {
        if (canvasState.referencedImageIds.has(imgId)) {
            removeImageRef(imgId);
        } else {
            canvasState.referencedImageIds.add(imgId);
            updateImageRefs();
        }
    }

    function removeImageRef(imgId) {
        canvasState.referencedImageIds.delete(imgId);
        updateImageRefs();
    }

    function clearAllRefs() {
        canvasState.referencedImageIds.clear();
        updateImageRefs();
    }

    function updateCanvasTransform() {
        const viewport = document.getElementById('canvasViewport');
        viewport.style.transform = `translate(${canvasState.translateX}px, ${canvasState.translateY}px) scale(${canvasState.scale})`;
        document.getElementById('zoomInfo').innerText = `${Math.round(canvasState.scale * 100)}%`;
    }

    function zoomIn() {
        canvasState.scale = Math.min(canvasState.scale * 1.2, 5);
        updateCanvasTransform();
    }

    function zoomOut() {
        canvasState.scale = Math.max(canvasState.scale / 1.2, 0.1);
        updateCanvasTransform();
    }

    function resetCanvas() {
        canvasState.scale = 1;
        canvasState.translateX = 0;
        canvasState.translateY = 0;
        updateCanvasTransform();
    }

    const selectionRect = document.getElementById('selectionRect');

    document.getElementById('canvasPanel').addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('canvas-image') || e.target.closest('.canvas-image')) return;

        // Ctrl + å·¦é”®ï¼šæ¡†é€‰æ¨¡å¼
        if (e.ctrlKey && e.button === 0) {
            e.preventDefault();
            canvasState.isSelecting = true;
            canvasState.selectStartX = e.clientX;
            canvasState.selectStartY = e.clientY;

            // éšè—æ¡†é€‰çŸ©å½¢
            selectionRect.classList.remove('show');
            selectionRect.style.left = '0';
            selectionRect.style.top = '0';
            selectionRect.style.width = '0';
            selectionRect.style.height = '0';

            // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­ï¼ˆä¿ç•™å½“å‰é€‰ä¸­çš„ï¼‰
            clearSelection();
        } else if (e.button === 0) {
            canvasState.isPanning = true;
            canvasState.lastMouseX = e.clientX;
            canvasState.lastMouseY = e.clientY;
        }
    });

    document.addEventListener('mousemove', (e) => {
        if (canvasState.isPanning) {
            const dx = e.clientX - canvasState.lastMouseX;
            const dy = e.clientY - canvasState.lastMouseY;
            canvasState.translateX += dx;
            canvasState.translateY += dy;
            canvasState.lastMouseX = e.clientX;
            canvasState.lastMouseY = e.clientY;
            updateCanvasTransform();
        }

        if (canvasState.isSelecting) {
            const rect = document.getElementById('canvasPanel').getBoundingClientRect();

            // è®¡ç®—æ¡†é€‰åŒºåŸŸ
            const left = Math.min(canvasState.selectStartX, e.clientX) - rect.left;
            const top = Math.min(canvasState.selectStartY, e.clientY) - rect.top;
            const width = Math.abs(e.clientX - canvasState.selectStartX);
            const height = Math.abs(e.clientY - canvasState.selectStartY);

            // æ˜¾ç¤ºæ¡†é€‰çŸ©å½¢
            selectionRect.classList.add('show');
            selectionRect.style.left = `${left}px`;
            selectionRect.style.top = `${top}px`;
            selectionRect.style.width = `${width}px`;
            selectionRect.style.height = `${height}px`;
        }
    });

    document.addEventListener('mouseup', (e) => {
        if (canvasState.isPanning) {
            canvasState.isPanning = false;
        }

        if (canvasState.isSelecting) {
            canvasState.isSelecting = false;

            // è·å–æ¡†é€‰åŒºåŸŸå†…çš„æ‰€æœ‰å›¾ç‰‡
            const panelRect = document.getElementById('canvasPanel').getBoundingClientRect();
            const selectLeft = Math.min(canvasState.selectStartX, e.clientX) - panelRect.left;
            const selectTop = Math.min(canvasState.selectStartY, e.clientY) - panelRect.top;
            const selectWidth = Math.abs(e.clientX - canvasState.selectStartX);
            const selectHeight = Math.abs(e.clientY - canvasState.selectStartY);

            if (selectWidth > 10 && selectHeight > 10) {
                selectImagesInRect(selectLeft, selectTop, selectWidth, selectHeight);
            }

            // éšè—æ¡†é€‰çŸ©å½¢
            selectionRect.classList.remove('show');
        }
    });

    document.getElementById('canvasPanel').addEventListener('wheel', (e) => {
        e.preventDefault();

        const panel = document.getElementById('canvasPanel');
        const rect = panel.getBoundingClientRect();

        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        const worldX = (mouseX - canvasState.translateX) / canvasState.scale;
        const worldY = (mouseY - canvasState.translateY) / canvasState.scale;

        const delta = e.deltaY > 0 ? 0.95 : 1.05;
        const newScale = Math.max(0.1, Math.min(5, canvasState.scale * delta));

        canvasState.translateX = mouseX - worldX * newScale;
        canvasState.translateY = mouseY - worldY * newScale;
        canvasState.scale = newScale;

        updateCanvasTransform();
    }, { passive: false });

    function clearSelection() {
        canvasState.selectedImageId = null;
        document.querySelectorAll('.canvas-image').forEach(el => el.classList.remove('selected'));
        const selectedTag = document.getElementById('selectedTag');
        if (selectedTag) selectedTag.classList.remove('show');
        const selectedHint = document.getElementById('selectedHint');
        if (selectedHint) selectedHint.classList.remove('show');
    }

    // æ¡†é€‰å›¾ç‰‡
    function selectImagesInRect(x, y, width, height) {
        const images = document.querySelectorAll('.canvas-image');
        images.forEach(img => {
            const imgX = parseInt(img.style.left) || 0;
            const imgY = parseInt(img.style.top) || 0;
            const imgWidth = img.offsetWidth;
            const imgHeight = img.offsetHeight;

            // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦åœ¨æ¡†é€‰åŒºåŸŸå†…
            if (imgX < x + width &&
                imgX + imgWidth > x &&
                imgY < y + height &&
                imgY + imgHeight > y) {
                img.classList.add('selected');
                canvasState.referencedImageIds.add(img.id);
            }
        });

        updateImageRefs();
        updateSelectedHint();
    }

    function updateSelectedHint() {
        const hint = document.getElementById('selectedHint');
        if (hint) {
            hint.innerHTML = `âœ“ å·²é€‰ä¸­ ${canvasState.referencedImageIds.size} å¼ å›¾ç‰‡ (ç‚¹å‡»æ¸…é™¤)`;
            if (canvasState.referencedImageIds.size > 0) {
                hint.classList.add('show');
            } else {
                hint.classList.remove('show');
            }
        }
    }

    // æ‰¹é‡ä¸‹è½½
    function downloadSelectedImages() {
        const images = document.querySelectorAll('.canvas-image.selected');
        if (images.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„å›¾ç‰‡');
            return;
        }

        let delay = 0;
        images.forEach(img => {
            const imgElement = img.querySelector('img');
            if (imgElement && imgElement.src) {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = imgElement.src;
                    link.download = `image_${img.dataset.number}.jpg`;
                    link.click();
                }, delay);
                delay += 300; // é¿å…æµè§ˆå™¨é˜»æ­¢å¤šæ¬¡ä¸‹è½½
            }
        });

        addMessage('ai', `æ­£åœ¨ä¸‹è½½ ${images.length} å¼ å›¾ç‰‡...`);
    }

    // æˆç»„
    function groupSelectedImages() {
        const images = document.querySelectorAll('.canvas-image.selected');
        if (images.length < 2) {
            alert('è¯·è‡³å°‘é€‰æ‹©2å¼ å›¾ç‰‡æ‰èƒ½æˆç»„');
            return;
        }

        const groupId = canvasState.nextGroupId++;
        canvasState.imageGroups[groupId] = [];

        images.forEach(img => {
            canvasState.imageGroups[groupId].push(img.id);
            canvasState.imageGroupMap[img.id] = groupId;
            img.classList.add('grouped');
            img.dataset.groupId = groupId;
        });

        addMessage('ai', `âœ“ å·²å°† ${images.length} å¼ å›¾ç‰‡æˆç»„`);
    }

    // è§£ç»„
    function ungroupSelectedImages() {
        const images = document.querySelectorAll('.canvas-image.selected');
        const groupIds = new Set();

        images.forEach(img => {
            const groupId = img.dataset.groupId;
            if (groupId) {
                groupIds.add(groupId);
                delete canvasState.imageGroupMap[img.id];
                img.classList.remove('grouped');
                delete img.dataset.groupId;
            }
        });

        // åˆ é™¤ç©ºç»„
        groupIds.forEach(groupId => {
            if (canvasState.imageGroups[groupId]) {
                delete canvasState.imageGroups[groupId];
            }
        });

        if (images.length > 0) {
            addMessage('ai', `âœ“ å·²è§£ç»„ ${images.length} å¼ å›¾ç‰‡`);
        }
    }

    // æ£€æŸ¥é€‰ä¸­çš„å›¾ç‰‡æ˜¯å¦éƒ½åœ¨åŒä¸€ç»„
    function areImagesInSameGroup() {
        const images = document.querySelectorAll('.canvas-image.selected');
        if (images.length === 0) return false;

        let groupId = null;
        for (const img of images) {
            const imgGroupId = img.dataset.groupId;
            if (imgGroupId === undefined) return false; // æœ‰å›¾ç‰‡æœªåˆ†ç»„

            if (groupId === null) {
                groupId = imgGroupId;
            } else if (groupId !== imgGroupId) {
                return false; // å›¾ç‰‡ä¸åœ¨åŒä¸€ç»„
            }
        }
        return true;
    }

    function makeImageSelectable(imgContainer) {
        let isDragging = false;
        let isClick = true;
        let startX, startY;
        let imageStartPositions = {}; // å­˜å‚¨ç»„å†…å›¾ç‰‡çš„åˆå§‹ä½ç½®

        imgContainer.addEventListener('mousedown', (e) => {
            if (e.button === 0) {
                e.stopPropagation();
                e.preventDefault();
                isDragging = true;
                isClick = true;
                startX = e.clientX;
                startY = e.clientY;

                // æ£€æŸ¥æ˜¯å¦é€‰ä¸­äº†å›¾ç‰‡
                const selectedImages = document.querySelectorAll('.canvas-image.selected');
                if (selectedImages.length > 0) {
                    // è®°å½•æ‰€æœ‰é€‰ä¸­å›¾ç‰‡çš„åˆå§‹ä½ç½®
                    selectedImages.forEach(img => {
                        imageStartPositions[img.id] = {
                            x: parseInt(img.style.left) || 0,
                            y: parseInt(img.style.top) || 0
                        };
                    });
                } else {
                    // å•å¼ å›¾ç‰‡
                    imageStartPositions[imgContainer.id] = {
                        x: parseInt(imgContainer.style.left) || 0,
                        y: parseInt(imgContainer.style.top) || 0
                    };
                }
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const dx = e.clientX - startX;
            const dy = e.clientY - startY;

            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                isClick = false;
            }

            const scaledDx = dx / canvasState.scale;
            const scaledDy = dy / canvasState.scale;

            const selectedImages = document.querySelectorAll('.canvas-image.selected');
            if (selectedImages.length > 0) {
                // ç§»åŠ¨æ‰€æœ‰é€‰ä¸­çš„å›¾ç‰‡
                selectedImages.forEach(img => {
                    const startPos = imageStartPositions[img.id];
                    if (startPos) {
                        img.style.left = `${startPos.x + scaledDx}px`;
                        img.style.top = `${startPos.y + scaledDy}px`;
                    }
                });
            } else {
                // ç§»åŠ¨å•å¼ å›¾ç‰‡
                const startPos = imageStartPositions[imgContainer.id];
                if (startPos) {
                    imgContainer.style.left = `${startPos.x + scaledDx}px`;
                    imgContainer.style.top = `${startPos.y + scaledDy}px`;
                }
            }
        });

        document.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            isDragging = false;

            if (isClick) {
                addImageRef(imgContainer.id);

                document.querySelectorAll('.canvas-image').forEach(el => el.classList.remove('selected'));
                canvasState.referencedImageIds.forEach(id => {
                    const img = document.getElementById(id);
                    if (img) img.classList.add('selected');
                });

                const hint = document.getElementById('selectedHint');
                if (hint) {
                    hint.innerHTML = `âœ“ å·²é€‰ä¸­ ${canvasState.referencedImageIds.size} å¼ å›¾ç‰‡ (ç‚¹å‡»æ¸…é™¤)`;
                }
            }
        });
    }

    function makeImageResizable(imgContainer, resizeHandle) {
        let isResizing = false;
        let startX, startY, startWidth, startHeight;

        resizeHandle.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            e.preventDefault();
            isResizing = true;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = imgContainer.offsetWidth;
            startHeight = imgContainer.offsetHeight;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const dx = (e.clientX - startX) / canvasState.scale;
            const dy = (e.clientY - startY) / canvasState.scale;

            // è·å–å®½é«˜æ¯”ï¼Œä¼˜å…ˆä½¿ç”¨å­˜å‚¨çš„å€¼ï¼Œå¦åˆ™ä»å½“å‰å°ºå¯¸è®¡ç®—
            const aspectRatio = parseFloat(imgContainer.dataset.aspectRatio) || (startWidth / startHeight);

            const newWidth = Math.max(100, startWidth + dx);
            const newHeight = newWidth / aspectRatio;

            imgContainer.style.width = `${newWidth}px`;
            imgContainer.style.height = `${newHeight}px`;
        });

        document.addEventListener('mouseup', () => {
            isResizing = false;
        });
    }

    // --- ç‹¬ç«‹ç¼–è¾‘çª—å£åŠŸèƒ½ ---

    let modalEditState = {
        currentTool: 'brush',
        isDrawing: false,
        lastX: 0,
        lastY: 0,
        currentImageId: null,
        originalImageData: null,
        annotationCanvas: null,
        annotationCtx: null
    };

    const editModal = document.getElementById('editModal');
    const modalCanvas = document.getElementById('editModalCanvas');
    const modalCtx = modalCanvas.getContext('2d');
    const cropOverlay = document.getElementById('cropOverlay');
    const cropBox = document.getElementById('cropBox');

    // å³é”®èœå•
    const contextMenu = document.getElementById('contextMenu');

    document.addEventListener('contextmenu', (e) => {
        const canvasImage = e.target.closest('.canvas-image');

        // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„å›¾ç‰‡
        const selectedImages = document.querySelectorAll('.canvas-image.selected');
        const hasSelection = selectedImages.length > 0;

        if (canvasImage || hasSelection) {
            e.preventDefault();

            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;

            // æ ¹æ®é€‰ä¸­çŠ¶æ€æ˜¾ç¤º/éšè—èœå•é¡¹
            const items = contextMenu.querySelectorAll('.context-menu-item');
            items.forEach(item => {
                const action = item.dataset.action;
                if (action === 'brush' || action === 'text' || action === 'crop') {
                    // ç¼–è¾‘åŠŸèƒ½ï¼šåªå¯¹å•å¼ å›¾ç‰‡æˆ–å³é”®ç‚¹å‡»çš„å›¾ç‰‡æ˜¾ç¤º
                    item.style.display = canvasImage && !hasSelection ? 'block' : 'none';
                } else if (action === 'download' || action === 'group') {
                    // æ‰¹é‡æ“ä½œï¼šéœ€è¦é€‰ä¸­å›¾ç‰‡
                    item.style.display = hasSelection ? 'block' : 'none';
                } else if (action === 'ungroup') {
                    // è§£ç»„ï¼šé€‰ä¸­å›¾ç‰‡åœ¨åŒä¸€ç»„æ‰æ˜¾ç¤º
                    item.style.display = hasSelection && areImagesInSameGroup() ? 'block' : 'none';
                } else if (action === 'reset') {
                    item.style.display = 'none'; // é‡ç½®åŠŸèƒ½ç°åœ¨åœ¨ç¼–è¾‘çª—å£å†…éƒ¨
                }
            });

            // å¦‚æœæ˜¯å³é”®ç‚¹å‡»å›¾ç‰‡ï¼Œè®¾ç½®å½“å‰å›¾ç‰‡ID
            if (canvasImage) {
                modalEditState.currentImageId = canvasImage.id;
            }

            contextMenu.classList.add('show');
        }
    });

    document.addEventListener('click', (e) => {
        if (!contextMenu.contains(e.target)) {
            contextMenu.classList.remove('show');
        }
    });

    contextMenu.addEventListener('click', (e) => {
        const item = e.target.closest('.context-menu-item');
        if (!item) return;

        const action = item.dataset.action;

        contextMenu.classList.remove('show');

        switch(action) {
            case 'brush':
            case 'text':
            case 'crop':
                // å•å›¾ç¼–è¾‘
                const singleImg = document.querySelector('.canvas-image.selected');
                if (singleImg) {
                    openEditModal(singleImg, action);
                } else if (modalEditState.currentImageId) {
                    const imgContainer = document.getElementById(modalEditState.currentImageId);
                    if (imgContainer) openEditModal(imgContainer, action);
                }
                break;
            case 'download':
                downloadSelectedImages();
                break;
            case 'group':
                groupSelectedImages();
                break;
            case 'ungroup':
                ungroupSelectedImages();
                break;
            case 'reset':
                resetCurrentEdit();
                break;
        }
    });

    function openEditModal(imgContainer, initialTool = 'brush') {
        const img = imgContainer.querySelector('img');

        // è®¾ç½®ç”»å¸ƒå¤§å°
        modalCanvas.width = img.naturalWidth;
        modalCanvas.height = img.naturalHeight;

        // åˆ›å»ºæ ‡æ³¨å±‚ç”»å¸ƒï¼ˆç”¨äºå­˜å‚¨æ ‡æ³¨ï¼‰
        modalEditState.annotationCanvas = document.createElement('canvas');
        modalEditState.annotationCanvas.width = img.naturalWidth;
        modalEditState.annotationCanvas.height = img.naturalHeight;
        modalEditState.annotationCtx = modalEditState.annotationCanvas.getContext('2d');

        // ç»˜åˆ¶åŸå›¾åˆ°ä¸»ç”»å¸ƒ
        modalCtx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
        modalCtx.drawImage(img, 0, 0);

        // ä¿å­˜åŸå§‹æ•°æ®
        modalEditState.originalImageData = modalCtx.getImageData(0, 0, modalCanvas.width, modalCanvas.height);

        // è®¾ç½®åˆå§‹å·¥å…·
        setEditMode(initialTool);

        // æ˜¾ç¤ºå¼¹çª—
        editModal.classList.add('show');

        // è®¾ç½®äº‹ä»¶
        setupModalCanvasEvents();
        setupCropEvents();
    }

    function closeEditModal() {
        editModal.classList.remove('show');
        cropOverlay.classList.remove('show');
        modalEditState.isDrawing = false;
        modalEditState.currentTool = 'brush';
    }

    function resetCurrentEdit() {
        // æ¸…é™¤æ ‡æ³¨å±‚
        if (modalEditState.annotationCtx) {
            modalEditState.annotationCtx.clearRect(0, 0, modalEditState.annotationCanvas.width, modalEditState.annotationCanvas.height);
        }

        // æ¢å¤åŸå›¾
        if (modalEditState.originalImageData) {
            modalCtx.putImageData(modalEditState.originalImageData, 0, 0);
        }

        // é‡ç½®è£å‰ªæ¡†
        const containerRect = document.querySelector('.edit-modal-canvas-container').getBoundingClientRect();
        cropBox.style.left = '10%';
        cropBox.style.top = '10%';
        cropBox.style.right = '10%';
        cropBox.style.bottom = '10%';

        addMessage('ai', 'âœ“ å·²é‡ç½®ç¼–è¾‘');
    }

    function setEditMode(tool) {
        modalEditState.currentTool = tool;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.edit-modal-toolbar .edit-tool-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tool === tool) btn.classList.add('active');
        });

        // æ˜¾ç¤º/éšè—è£å‰ªå±‚
        if (tool === 'crop') {
            cropOverlay.classList.add('show');
            const containerRect = document.querySelector('.edit-modal-canvas-container').getBoundingClientRect();
            const canvasRect = modalCanvas.getBoundingClientRect();
            const scaleX = modalCanvas.width / canvasRect.width;
            const scaleY = modalCanvas.height / canvasRect.height;

            // è®¾ç½®åˆå§‹è£å‰ªæ¡†
            cropBox.style.left = '10%';
            cropBox.style.top = '10%';
            cropBox.style.right = '10%';
            cropBox.style.bottom = '10%';
            cropBox.style.width = '80%';
            cropBox.style.height = '80%';
        } else {
            cropOverlay.classList.remove('show');
        }

        // è®¾ç½®å…‰æ ‡
        if (tool === 'text') {
            modalCanvas.style.cursor = 'text';
        } else if (tool === 'crop') {
            modalCanvas.style.cursor = 'default';
        } else {
            modalCanvas.style.cursor = 'crosshair';
        }
    }

    function setupModalCanvasEvents() {
        modalCanvas.onmousedown = (e) => {
            if (modalEditState.currentTool === 'text' || modalEditState.currentTool === 'crop') return;

            modalEditState.isDrawing = true;
            const rect = modalCanvas.getBoundingClientRect();
            modalEditState.lastX = (e.clientX - rect.left) * (modalCanvas.width / rect.width);
            modalEditState.lastY = (e.clientY - rect.top) * (modalCanvas.height / rect.height);
        };

        modalCanvas.onmousemove = (e) => {
            if (!modalEditState.isDrawing || modalEditState.currentTool === 'text' || modalEditState.currentTool === 'crop') return;

            const rect = modalCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (modalCanvas.width / rect.width);
            const y = (e.clientY - rect.top) * (modalCanvas.height / rect.height);

            const color = document.getElementById('modalColorPicker').value;
            const size = parseInt(document.getElementById('modalBrushSize').value);

            // åœ¨æ ‡æ³¨å±‚ç»˜åˆ¶
            modalEditState.annotationCtx.beginPath();
            modalEditState.annotationCtx.moveTo(modalEditState.lastX, modalEditState.lastY);
            modalEditState.annotationCtx.lineTo(x, y);
            modalEditState.annotationCtx.strokeStyle = color;
            modalEditState.annotationCtx.lineWidth = size;
            modalEditState.annotationCtx.lineCap = 'round';
            modalEditState.annotationCtx.lineJoin = 'round';

            if (modalEditState.currentTool === 'eraser') {
                // æ©¡çš®æ“¦ï¼šæ¸…é™¤æ ‡æ³¨å±‚
                modalEditState.annotationCtx.globalCompositeOperation = 'destination-out';
                modalEditState.annotationCtx.lineWidth = size * 3;
            } else {
                modalEditState.annotationCtx.globalCompositeOperation = 'source-over';
            }
            modalEditState.annotationCtx.stroke();

            modalEditState.lastX = x;
            modalEditState.lastY = y;

            // å®æ—¶åˆå¹¶æ˜¾ç¤º
            modalCtx.putImageData(modalEditState.originalImageData, 0, 0);
            modalCtx.drawImage(modalEditState.annotationCanvas, 0, 0);
        };

        modalCanvas.onmouseup = () => modalEditState.isDrawing = false;
        modalCanvas.onmouseleave = () => modalEditState.isDrawing = false;

        // æ–‡å­—è¾“å…¥
        modalCanvas.onclick = (e) => {
            if (modalEditState.currentTool !== 'text') return;

            const rect = modalCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (modalCanvas.width / rect.width);
            const y = (e.clientY - rect.top) * (modalCanvas.height / rect.height);

            const text = prompt('è¯·è¾“å…¥æ–‡å­—:');
            if (text && text.trim()) {
                const color = document.getElementById('modalColorPicker').value;
                const size = parseInt(document.getElementById('modalBrushSize').value) * 4 + 12;
                modalEditState.annotationCtx.font = `${size}px Arial, sans-serif`;
                modalEditState.annotationCtx.fillStyle = color;
                modalEditState.annotationCtx.textBaseline = 'middle';
                modalEditState.annotationCtx.globalCompositeOperation = 'source-over';
                modalEditState.annotationCtx.fillText(text.trim(), x, y);

                // å®æ—¶åˆå¹¶æ˜¾ç¤º
                modalCtx.putImageData(modalEditState.originalImageData, 0, 0);
                modalCtx.drawImage(modalEditState.annotationCanvas, 0, 0);
            }
        };
    }

    function setupCropEvents() {
        let isDragging = false;
        let isResizing = false;
        let currentHandle = null;
        let startX, startY, startLeft, startTop, startWidth, startHeight;

        // ç§»åŠ¨è£å‰ªæ¡†
        cropBox.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('crop-handle')) return;
            e.preventDefault();
            e.stopPropagation();
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startLeft = cropBox.offsetLeft;
            startTop = cropBox.offsetTop;
        });

        // è°ƒæ•´è£å‰ªæ¡†å¤§å°
        cropOverlay.querySelectorAll('.crop-handle').forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                isResizing = true;
                currentHandle = handle.className.split(' ')[1];
                startX = e.clientX;
                startY = e.clientY;
                startLeft = cropBox.offsetLeft;
                startTop = cropBox.offsetTop;
                startWidth = cropBox.offsetWidth;
                startHeight = cropBox.offsetHeight;
            });
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                cropBox.style.left = `${startLeft + dx}px`;
                cropBox.style.top = `${startTop + dy}px`;
            }

            if (isResizing) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                if (currentHandle === 'se') {
                    cropBox.style.width = `${startWidth + dx}px`;
                    cropBox.style.height = `${startHeight + dy}px`;
                } else if (currentHandle === 'sw') {
                    cropBox.style.left = `${startLeft + dx}px`;
                    cropBox.style.width = `${startWidth - dx}px`;
                    cropBox.style.height = `${startHeight + dy}px`;
                } else if (currentHandle === 'ne') {
                    cropBox.style.top = `${startTop + dy}px`;
                    cropBox.style.width = `${startWidth + dx}px`;
                    cropBox.style.height = `${startHeight - dy}px`;
                } else if (currentHandle === 'nw') {
                    cropBox.style.left = `${startLeft + dx}px`;
                    cropBox.style.top = `${startTop + dy}px`;
                    cropBox.style.width = `${startWidth - dx}px`;
                    cropBox.style.height = `${startHeight - dy}px`;
                }
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            isResizing = false;
        });
    }

    function confirmModalEdit() {
        const imgContainer = document.getElementById(modalEditState.currentImageId);
        const img = imgContainer.querySelector('img');

        if (modalEditState.currentTool === 'crop') {
            // æ‰§è¡Œè£å‰ª
            const containerRect = document.querySelector('.edit-modal-canvas-container').getBoundingClientRect();
            const canvasRect = modalCanvas.getBoundingClientRect();

            const scaleX = modalCanvas.width / canvasRect.width;
            const scaleY = modalCanvas.height / canvasRect.height;

            const cropLeft = cropBox.offsetLeft * scaleX;
            const cropTop = cropBox.offsetTop * scaleY;
            const cropWidth = cropBox.offsetWidth * scaleX;
            const cropHeight = cropBox.offsetHeight * scaleY;

            // åˆ›å»ºè£å‰ªåçš„å›¾åƒ
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = cropWidth;
            tempCanvas.height = cropHeight;
            const tempCtx = tempCanvas.getContext('2d');

            tempCtx.drawImage(
                modalCanvas,
                cropLeft,
                cropTop,
                cropWidth,
                cropHeight,
                0, 0,
                cropWidth,
                cropHeight
            );

            const croppedBase64 = tempCanvas.toDataURL('image/jpeg', 0.95);
            img.src = croppedBase64;
        } else {
            // åˆå¹¶æ ‡æ³¨å±‚
            modalCtx.putImageData(modalEditState.originalImageData, 0, 0);
            modalCtx.drawImage(modalEditState.annotationCanvas, 0, 0);

            const editedBase64 = modalCanvas.toDataURL('image/jpeg', 0.95);
            img.src = editedBase64;
        }

        // æ›´æ–°å®¹å™¨å®½é«˜æ¯”
        img.onload = () => {
            const width = img.naturalWidth;
            const height = img.naturalHeight;
            const aspectRatio = width / height;
            imgContainer.dataset.aspectRatio = aspectRatio;

            const sizeLabel = imgContainer.querySelector('.image-size');
            if (sizeLabel) {
                sizeLabel.textContent = `${width}x${height}`;
            }

            const newHeight = (imgContainer.offsetWidth / aspectRatio);
            imgContainer.style.height = `${newHeight}px`;
        };

        closeEditModal();
        addMessage('ai', 'âœ“ ç¼–è¾‘å·²ä¿å­˜åˆ°ç”»å¸ƒ');
    }

</script>

<script>
    document.getElementById('modelSelect').addEventListener('change', (e) => {
        const customInput = document.getElementById('customModel');
        if (e.target.value === 'custom') {
            customInput.style.display = 'block';
        } else {
            customInput.style.display = 'none';
        }
    });

    const originalImageSend = window.send;

    // --- åŠŸèƒ½åˆ‡æ¢ ---
    let currentMode = 'image'; // 'image' æˆ– 'video'

    function switchMode(mode) {
        currentMode = mode;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });

        // åˆ‡æ¢è®¾ç½®é¢æ¿
        const imageSettings = document.getElementById('imageSettings');
        const videoSettings = document.getElementById('videoSettings');

        if (mode === 'image') {
            imageSettings.style.display = 'block';
            videoSettings.classList.remove('show');
            document.getElementById('prompt').placeholder = 'ç‚¹å‡»å³ä¾§å›¾ç‰‡æ·»åŠ åˆ°å‚è€ƒåˆ—è¡¨...';
            document.getElementById('sendBtn').textContent = 'å‘é€';
        } else {
            imageSettings.style.display = 'none';
            videoSettings.classList.add('show');
            document.getElementById('prompt').placeholder = 'æè¿°è§†é¢‘å†…å®¹...';
            document.getElementById('sendBtn').textContent = 'ç”Ÿæˆè§†é¢‘';
        }

        // ä¿å­˜æ¨¡å¼åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('currentMode', mode);
    }

// ç›‘å¬æ¨¡å‹å˜åŒ–ï¼Œè°ƒæ•´æç¤º
document.getElementById('videoModel')?.addEventListener('change', (e) => {
    const model = e.target.value;
    const hint = {
        'veo3.1': 'å¿«é€Ÿæ¨¡å¼ï¼Œæ”¯æŒè‡ªåŠ¨éŸ³é¢‘ç”Ÿæˆï¼Œæ€§ä»·æ¯”æœ€é«˜',
        'veo3.1-pro': 'é«˜è´¨é‡æ¨¡å¼ï¼Œæ”¯æŒè‡ªåŠ¨éŸ³é¢‘ç”Ÿæˆï¼Œè´¨é‡è¶…é«˜',
        'veo3-pro-frames': 'å•å›¾å‚è€ƒï¼Œä»…æ”¯æŒé¦–å¸§',
        'veo3-fast-frames': 'å¿«é€Ÿå›¾ç”Ÿè§†é¢‘',
        'veo2-fast-frames': 'æ”¯æŒé¦–å°¾å¸§ï¼ˆæœ€å¤š2å¼ å›¾ï¼‰',
        'veo2-fast-components': 'å¤šå›¾å…ƒç´ å‚è€ƒï¼ˆæœ€å¤š3å¼ å›¾ï¼‰',
        'veo3.1-components': '1-3å¼ å›¾å‚è€ƒ'
    };
    addMessage('ai', `ğŸ’¡ ${model}: ${hint[model] || ''}`);
});

    // --- è§†é¢‘ç”ŸæˆåŠŸèƒ½ ---
    async function sendVideo() {
        const input = document.getElementById('prompt');
        const text = input.value.trim();
        const baseUrl = document.getElementById('baseUrl').value;
        const apiKey = document.getElementById('apiKey').value;

        if (!baseUrl || !apiKey) return alert("è¯·å…ˆå¡«å†™ API é…ç½®ï¼");
        if (canvasState.referencedImageIds.size === 0) return alert("è¯·å…ˆåœ¨ç”»å¸ƒä¸­é€‰æ‹©å‚è€ƒå›¾ç‰‡ï¼");
        if (!text) return alert("è¯·æè¿°è§†é¢‘å†…å®¹ï¼");

        // æ£€æŸ¥å›¾ç‰‡æ•°é‡
        const model = document.getElementById('videoModel').value;
        const imageCount = canvasState.referencedImageIds.size;

        if (model === 'veo3-pro-frames' && imageCount > 1) {
            return alert('veo3-pro-frames æœ€å¤šæ”¯æŒ1å¼ å‚è€ƒå›¾ç‰‡');
        }
        if (model === 'veo2-fast-frames' && imageCount > 2) {
            return alert('veo2-fast-frames æœ€å¤šæ”¯æŒ2å¼ å‚è€ƒå›¾ç‰‡');
        }
        if ((model === 'veo2-fast-components' || model === 'veo3.1-components') && imageCount > 3) {
            return alert('æ­¤æ¨¡å‹æœ€å¤šæ”¯æŒ3å¼ å‚è€ƒå›¾ç‰‡');
        }

        addMessage('user', text);
        input.value = '';

        // æ”¶é›†å‚è€ƒå›¾
        const images = [];
        canvasState.referencedImageIds.forEach(imgId => {
            const imgContainer = document.getElementById(imgId);
            if (imgContainer) {
                const img = imgContainer.querySelector('img');
                if (img && img.src) {
                    const base64 = img.src.split(',')[1];
                    images.push(base64);
                }
            }
        });

        // æ˜¾ç¤ºè¿›åº¦æ¡
        showProgress('æ­£åœ¨æäº¤ä»»åŠ¡...', 0);

        try {
            const payload = {
                prompt: text,
                model: model,
                images: images,
                enhance_prompt: document.getElementById('enhancePrompt').checked
            };

            const aspectRatio = document.getElementById('videoAspectRatio').value;
            payload.aspect_ratio = aspectRatio;

            const endpoint = `${baseUrl.replace(/\/$/, '')}/v2/videos/generations`;

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || "æäº¤å¤±è´¥");

            const taskId = data.task_id;
            if (!taskId) throw new Error("æœªè·å–åˆ°ä»»åŠ¡ID");

            // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
            await pollTaskStatus(taskId, baseUrl, apiKey);

        } catch (e) {
            addMessage('ai', 'âŒ å‡ºé”™äº†: ' + e.message);
            hideProgress();
        }
    }

    async function pollTaskStatus(taskId, baseUrl, apiKey) {
        let attempts = 0;
        const maxAttempts = 300; // æœ€å¤šè½®è¯¢5åˆ†é’Ÿ

        while (attempts < maxAttempts) {
            attempts++;

            try {
                const endpoint = `${baseUrl.replace(/\/$/, '')}/v2/videos/generations/${taskId}`;

                const response = await fetch(endpoint, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });

                const data = await response.json();
                if (!response.ok) throw new Error("æŸ¥è¯¢å¤±è´¥");

                const status = data.status;
                const progress = data.progress || '0%';

                updateProgress(status, progress);

                if (status === 'SUCCESS') {
                    const videoUrl = data.data?.output;
                    if (videoUrl) {
                        await downloadAndShowVideo(videoUrl);
                        addMessage('ai', `âœ“ è§†é¢‘ç”Ÿæˆå®Œæˆï¼å·²åœ¨ç”»å¸ƒä¸­æ˜¾ç¤ºã€‚`);
                    } else {
                        throw new Error("æœªè·å–åˆ°è§†é¢‘é“¾æ¥");
                    }
                    hideProgress();
                    return;
                } else if (status === 'FAILURE') {
                    throw new Error(data.fail_reason || 'ç”Ÿæˆå¤±è´¥');
                }

                // ç­‰å¾…3ç§’åå†æ¬¡æŸ¥è¯¢
                await new Promise(resolve => setTimeout(resolve, 3000));

            } catch (e) {
                console.error('è½®è¯¢é”™è¯¯:', e);
                await new Promise(resolve => setTimeout(resolve, 3000));
            }
        }

        throw new Error("ç”Ÿæˆè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
    }

    async function downloadAndShowVideo(videoUrl) {
        try {
            const response = await fetch(videoUrl);
            const blob = await response.blob();
            const videoFile = new File([blob], `video_${Date.now()}.mp4`, { type: 'video/mp4' });
            updateCanvasWithVideo(videoFile);
        } catch (e) {
            console.error('ä¸‹è½½è§†é¢‘å¤±è´¥:', e);
            throw e;
        }
    }

    function showProgress(title, progress) {
        const container = document.getElementById('progressContainer');
        const titleEl = document.getElementById('progressTitle');
        const fillEl = document.getElementById('progressFill');
        const statusEl = document.getElementById('progressStatus');

        titleEl.textContent = title;
        fillEl.style.width = progress;
        statusEl.textContent = 'å‡†å¤‡ä¸­...';
        container.classList.add('show');
    }

    function updateProgress(status, progress) {
        const titleEl = document.getElementById('progressTitle');
        const fillEl = document.getElementById('progressFill');
        const statusEl = document.getElementById('progressStatus');

        const statusText = {
            'NOT_START': 'ä»»åŠ¡æ’é˜Ÿä¸­',
            'IN_PROGRESS': 'æ­£åœ¨ç”Ÿæˆè§†é¢‘...',
            'SUCCESS': 'ç”Ÿæˆå®Œæˆ',
            'FAILURE': 'ç”Ÿæˆå¤±è´¥'
        };

        titleEl.textContent = statusText[status] || 'å¤„ç†ä¸­...';
        fillEl.style.width = progress;
        statusEl.textContent = `è¿›åº¦: ${progress}`;
    }

    function hideProgress() {
        const container = document.getElementById('progressContainer');
        container.classList.remove('show');
    }

    // --- ä¿®æ”¹å‘é€å‡½æ•° ---
    window.send = async function() {
        // ä¿å­˜å›¾ç‰‡ç”Ÿæˆè®¾ç½®
        if (currentMode !== 'video') {
            const aspectRatio = document.getElementById('aspectRatio').value;
            const resolution = document.getElementById('resolution').value;
            const model = document.getElementById('modelSelect').value;
            const responseFormat = document.getElementById('responseFormat').value;
            localStorage.setItem('aspectRatio', aspectRatio);
            localStorage.setItem('resolution', resolution);
            localStorage.setItem('model', model);
            localStorage.setItem('responseFormat', responseFormat);
        }

        // æ ¹æ®æ¨¡å¼è°ƒç”¨ä¸åŒå‡½æ•°
        if (currentMode === 'video') {
            await sendVideo();
        } else {
            await originalImageSend();
        }
    };

    // --- æ·»åŠ è§†é¢‘åˆ°ç”»å¸ƒ ---
    function updateCanvasWithVideo(videoFile) {
        const imagesContainer = document.getElementById('canvasImages');
        const placeholder = document.getElementById('placeholder');

        if (placeholder) placeholder.style.display = 'none';

        const videoContainer = document.createElement('div');
        videoContainer.className = 'video-container canvas-image';
        videoContainer.id = `video-container-${canvasState.imageCount}`;
        const videoNumber = canvasState.imageCount + 1;
        videoContainer.dataset.number = videoNumber;

        // ç¼–å·æ ‡ç­¾
        const numberLabel = document.createElement('div');
        numberLabel.className = 'image-number';
        numberLabel.textContent = `V${videoNumber}`;
        videoContainer.appendChild(numberLabel);

        // è§†é¢‘å…ƒç´ 
        const video = document.createElement('video');
        video.src = URL.createObjectURL(videoFile);
        video.controls = true;
        video.autoplay = true;
        video.loop = true;
        video.muted = true;
        video.style.width = '100%';
        video.style.height = '100%';
        videoContainer.appendChild(video);

        // å·¥å…·æ 
        const toolsBar = document.createElement('div');
        toolsBar.className = 'image-tools';

        const downloadBtn = document.createElement('div');
        downloadBtn.className = 'download-btn';
        downloadBtn.innerHTML = 'â¬‡ ä¸‹è½½';
        downloadBtn.onclick = (e) => {
            e.stopPropagation();
            const link = document.createElement('a');
            link.href = video.src;
            link.download = `video_${videoNumber}.mp4`;
            link.click();
        };
        toolsBar.appendChild(downloadBtn);

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'ğŸ—‘ åˆ é™¤';
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            removeImageRef(videoContainer.id);
            videoContainer.remove();
        };
        toolsBar.appendChild(deleteBtn);

        videoContainer.appendChild(toolsBar);

        // åˆå§‹å°ºå¯¸
        videoContainer.style.width = '400px';
        videoContainer.style.height = '225px';

        makeImageSelectable(videoContainer);

        imagesContainer.appendChild(videoContainer);
        canvasState.imageCount++;

        addMessage('ai', `ğŸ“¹ å·²æ·»åŠ è§†é¢‘ #V${videoNumber} åˆ°ç”»å¸ƒ`);
    }

    // ç¼¤çº·ç¤¼èŠ±æ•ˆæœ
    function createConfetti() {
        const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#f38181', '#aa96da', '#fcbad3', '#a8e6cf', '#ffd93d', '#6bcb77'];
        const shapes = ['square', 'circle', 'triangle'];
        const confettiCount = 150;

        for (let i = 0; i < confettiCount; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            
            // éšæœºé¢œè‰²å’Œå½¢çŠ¶
            const color = colors[Math.floor(Math.random() * colors.length)];
            const shape = shapes[Math.floor(Math.random() * shapes.length)];
            
            confetti.style.backgroundColor = color;
            confetti.style.left = '50%';
            confetti.style.top = '50%';
            
            // æ ¹æ®å½¢çŠ¶è®¾ç½®æ ·å¼
            if (shape === 'circle') {
                confetti.style.borderRadius = '50%';
            } else if (shape === 'triangle') {
                confetti.style.width = '0';
                confetti.style.height = '0';
                confetti.style.backgroundColor = 'transparent';
                confetti.style.borderLeft = '5px solid transparent';
                confetti.style.borderRight = '5px solid transparent';
                confetti.style.borderBottom = `10px solid ${color}`;
            } else {
                confetti.style.borderRadius = '2px';
            }
            
            document.body.appendChild(confetti);
            
            // éšæœºè¿åŠ¨å‚æ•°
            const angle = (Math.random() * 360) * (Math.PI / 180);
            const velocity = 2 + Math.random() * 8;
            const rotationSpeed = -5 + Math.random() * 10;
            
            let x = 0;
            let y = 0;
            let rotation = 0;
            let vx = Math.cos(angle) * velocity;
            let vy = Math.sin(angle) * velocity - 6;
            let opacity = 1;
            let scale = 1;
            
            const animate = () => {
                x += vx;
                y += vy;
                vy += 0.2; // é‡åŠ›
                vx *= 0.985; // ç©ºæ°”é˜»åŠ›
                rotation += rotationSpeed;
                opacity -= 0.008;
                scale *= 0.997;
                
                confetti.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg) scale(${scale})`;
                confetti.style.opacity = opacity;
                
                if (opacity > 0) {
                    requestAnimationFrame(animate);
                } else {
                    confetti.remove();
                }
            };
            
            // å»¶è¿Ÿå¯åŠ¨åŠ¨ç”»
            setTimeout(() => {
                requestAnimationFrame(animate);
            }, Math.random() * 200);
        }
    }
</script>

</body>
</html>
